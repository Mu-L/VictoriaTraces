`lib/proto` contains all the (OpenTelemetry proto) files, documentation, and commands to help generate `.go` files from the proto files.

## Folder structure

To make it easier to sync with the [`opentelemetry-proto`](https://github.com/open-telemetry/opentelemetry-proto/tree/v1.8.0/opentelemetry/proto) repository,
`lib/proto` contains the same folder structure as `opentelemetry-proto`:

```shell
└── lib
    └── proto
        └── opentelemetry
            └── proto
                ├── collector
                │   └── trace
                │       └── v1
                ├── common
                │   └── v1
                ├── resource
                │   └── v1
                └── trace
                    └── v1
```

## Updating proto files

When updating the proto files, simply copy and paste the `opentelemetry` folder from the [upstream](https://github.com/open-telemetry/opentelemetry-proto) to `lib/proto`,
and remove unnecessary signal folders (such as `metrics/v1`, `profiles/v1development`, `collector/metrics/v1`, and more).

To handle the `go import` path correctly, replace the following line prefix in `.proto` files:
```protobuf
option go_package = "go.opentelemetry.io/proto/otlp/
```
to
```protobuf
option go_package = "github.com/VictoriaMetrics/VictoriaTraces/lib/proto/opentelemetry/proto/
```

## Compiling
Run the following command from the VictoriaTraces repository's root folder:
```make
make gen-otel-proto
```

It will run [buf](https://github.com/bufbuild/buf) with docker, compile and output the `.go` files to the same folder of your `.proto` files.

The `buf` command sends request to remote server and has [rate limiting](https://buf.build/docs/bsr/rate-limits/#code-generation). To increase the rate limit,
you may need to register on [buf.build]() and authenticate locally using an environment variable or CLI. See [this doc](https://buf.build/docs/bsr/authentication/#authenticating-locally) for details.

```Makefile
gen-otel-proto:
    $(DOCKER_RUN) -e BUF_TOKEN={YOUR_BUF_TOKEN} --volume "$(shell pwd)/lib/proto:/workspace" --workdir /workspace bufbuild/buf generate
```

## Replace with easyproto

Currently, VictoriaTraces uses [`easyproto`](https://github.com/VictoriaMetrics/easyproto) for (un)marshaling protocol buffer.
While the gRPC service (generated by the instruction above), by default, use internal (un)marshaler.

To replace it with `easyproto`, we need to:
1. replace the structs required by service with the structs we're using.
2. replace the (un)marshaler.

For the 1-step, we need to modify the reference of struct such as `*ExportTraceServiceRequest` and `*ExportTraceServiceResponse`
in `trace_service_grpc.pb.go`. It can be done by various ways:
- changing the import path of these structs.
- copy and paste the `trace_service_grpc.pb.go` to `lib/protoparser/opentelemetry/pb` and rename the `package`. So it can share the existing structs under the same `package`.

For the 2-step, register our own codec at `lib/protoparser/opentelemetry/pb/codec.go`. This is a one-time job and there's no need to do it anymore when updating the protocol.